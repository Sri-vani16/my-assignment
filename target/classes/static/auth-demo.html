<!DOCTYPE html>
<html>
<head>
    <title>Auth Service Demo</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 8px 15px; margin: 5px; }
        input { padding: 5px; margin: 5px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .token { word-break: break-all; font-size: 12px; }
    </style>
</head>
<body>
    <h1>AuthService Demo - Login, Logout, Token Validation</h1>
    
    <!-- Login Section -->
    <div class="section">
        <h3>1. Login (AuthService.login())</h3>
        <input type="text" id="username" placeholder="Username" value="admin">
        <input type="password" id="password" placeholder="Password" value="password">
        <button onclick="login()">Login</button>
        <div class="result" id="loginResult"></div>
    </div>
    
    <!-- Token Validation Section -->
    <div class="section">
        <h3>2. Token Validation (AuthService.validateToken())</h3>
        <button onclick="validateToken()">Validate Current Token</button>
        <div class="result" id="validateResult"></div>
    </div>
    
    <!-- Protected API Call -->
    <div class="section">
        <h3>3. Use Token for Protected API</h3>
        <button onclick="getUsers()">Get All Users</button>
        <div class="result" id="usersResult"></div>
    </div>
    
    <!-- Logout Section -->
    <div class="section">
        <h3>4. Logout (AuthService.logout())</h3>
        <button onclick="logout()">Logout</button>
        <div class="result" id="logoutResult"></div>
    </div>
    
    <!-- Test After Logout -->
    <div class="section">
        <h3>5. Test Token After Logout</h3>
        <button onclick="testAfterLogout()">Try Protected API After Logout</button>
        <div class="result" id="afterLogoutResult"></div>
    </div>

    <script>
        let currentToken = '';
        
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/users/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    currentToken = await response.text();
                    currentToken = currentToken.replace(/"/g, ''); // Remove quotes
                    document.getElementById('loginResult').innerHTML = 
                        `<strong>✅ Login Successful!</strong><br>
                         <div class="token">Token: ${currentToken}</div>`;
                } else {
                    document.getElementById('loginResult').innerHTML = 
                        `<strong>❌ Login Failed:</strong> ${response.status}`;
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    `<strong>❌ Error:</strong> ${error.message}`;
            }
        }
        
        async function validateToken() {
            if (!currentToken) {
                document.getElementById('validateResult').innerHTML = 
                    '<strong>❌ No token available. Please login first.</strong>';
                return;
            }
            
            try {
                const response = await fetch('/auth/validate', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const result = await response.json();
                document.getElementById('validateResult').innerHTML = 
                    `<strong>Token Validation:</strong> ${result.valid ? '✅ Valid' : '❌ Invalid'}`;
            } catch (error) {
                document.getElementById('validateResult').innerHTML = 
                    `<strong>❌ Error:</strong> ${error.message}`;
            }
        }
        
        async function getUsers() {
            if (!currentToken) {
                document.getElementById('usersResult').innerHTML = 
                    '<strong>❌ No token available. Please login first.</strong>';
                return;
            }
            
            try {
                const response = await fetch('/users', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    document.getElementById('usersResult').innerHTML = 
                        `<strong>✅ Protected API Success:</strong><br>
                         <pre>${JSON.stringify(users, null, 2)}</pre>`;
                } else {
                    document.getElementById('usersResult').innerHTML = 
                        `<strong>❌ Protected API Failed:</strong> ${response.status}`;
                }
            } catch (error) {
                document.getElementById('usersResult').innerHTML = 
                    `<strong>❌ Error:</strong> ${error.message}`;
            }
        }
        
        async function logout() {
            if (!currentToken) {
                document.getElementById('logoutResult').innerHTML = 
                    '<strong>❌ No token available. Please login first.</strong>';
                return;
            }
            
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('logoutResult').innerHTML = 
                        `<strong>✅ ${result.message}</strong><br>Token blacklisted successfully.`;
                } else {
                    document.getElementById('logoutResult').innerHTML = 
                        `<strong>❌ Logout Failed:</strong> ${response.status}`;
                }
            } catch (error) {
                document.getElementById('logoutResult').innerHTML = 
                    `<strong>❌ Error:</strong> ${error.message}`;
            }
        }
        
        async function testAfterLogout() {
            if (!currentToken) {
                document.getElementById('afterLogoutResult').innerHTML = 
                    '<strong>❌ No token available.</strong>';
                return;
            }
            
            try {
                const response = await fetch('/users', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (response.ok) {
                    document.getElementById('afterLogoutResult').innerHTML = 
                        '<strong>❌ Unexpected: API call succeeded after logout!</strong>';
                } else {
                    document.getElementById('afterLogoutResult').innerHTML = 
                        `<strong>✅ Expected: API call failed after logout (${response.status})</strong><br>
                         Token successfully blacklisted!`;
                }
            } catch (error) {
                document.getElementById('afterLogoutResult').innerHTML = 
                    `<strong>✅ Expected Error:</strong> ${error.message}`;
            }
        }
    </script>
</body>
</html>